define("apps/integration-google-drive/app",["require","jquery","lodash","monster","toastr"],function(t){var n=t("jquery"),e=t("lodash"),a=t("monster"),o=t("toastr");return{name:"skeleton",css:["app"],i18n:{"en-US":{customCss:!1},"fr-FR":{customCss:!1}},appFlags:{appData:{storage:{}}},requests:{},subscribe:{},load:function(t){var n=this;n.initApp(function(){t&&t(n)})},initApp:function(t){var n=this;a.pub("auth.initApp",{app:n,callback:t})},render:function(t){var n=this;a.ui.generateAppLayout(n,{menus:[{tabs:[{callback:n.renderListAccounts}]}]})},renderListAccounts:function(t){var e=this,a=t||{},o=a.container||n("#integration_google_drive_app_container .app-content-wrapper");e.getGoogleDriveAccounts(function(t){var a=e.formatGoogleDriveData(t),i=n(e.getTemplate({name:"layout",data:a}));e.bindListingView(i),o.fadeOut(function(){n(this).empty().append(i).fadeIn()})})},renderEditConfiguration:function(t){var e=this,o=n("#integration_google_drive_app_container .app-content-wrapper");e.getConfigurationData(t,function(i){var l=e.formatEditConfigurationData(i),r=n(a.template(e,"edit-configuration",l));e.renderGoogleField(r,l.googleUser),e.bindEditConfiguration(r,i,t),o.fadeOut(function(){n(this).empty().append(r).fadeIn()})})},renderGoogleField:function(t,n){var o=this,i=n||{},l={isConfigured:!1,hasGoogleInfo:!1,docId:void 0,hasGoogleProvider:!1};a.config.whitelabel.hasOwnProperty("sso_providers")&&(l.hasGoogleProvider=e.filter(a.config.whitelabel.sso_providers,function(t){return"google"===t.name}).length>0),i.hasOwnProperty("auth_id")&&(l.isConfigured=!0,l.docId=i.auth_id),i.hasOwnProperty("email")&&(l.hasGoogleInfo=!0,l.email=i.email),t.find(".google-field-wrapper").empty().append(a.template(o,"google-field",l)),i.hasOwnProperty("photoUrl")&&a.pub("auth.paintSSOPhoto",{container:t.find(".user-photo-div-container"),ssoToken:i})},bindEditConfiguration:function(t,n,e){var i=this,l=t.find("#configuration_form");a.ui.protectField(t.find("#settings_key"),t),a.ui.protectField(t.find("#settings_secret"),t),a.ui.validate(l),t.on("click",".populate-link",function(){a.pub("auth.loginToSSOProvider",{providerName:"google",additionalParams:{scopes:["https://www.googleapis.com/auth/drive.file"],access_type:"offline"},success:function(n){i.renderGoogleField(t,a.util.jwt_decode(n.auth_token))}})}),t.on("click",".reset-sso-link",function(){i.renderGoogleField(t)}),t.find("#cancel").on("click",function(t){t.preventDefault(),i.renderListAccounts()}),t.find("#save").on("click",function(t){if(t.preventDefault(),a.ui.valid(l)){var r=a.ui.getFormData("configuration_form"),s=i.configurationCleanFormData(r,n);i.saveGoogleDriveConfiguration(e,s,function(t){o.success(a.template(i,"!"+i.i18n.active().integrationGoogleDrive.edition.successUpdate,{variable:t.name})),i.renderListAccounts()})}})},configurationCleanFormData:function(t,e){var a=n.extend(!0,e,t);return delete a.extra,a},formatEditConfigurationData:function(t){var n={configuration:t,googleUser:t&&t.hasOwnProperty("extra")&&t.extra.hasOwnProperty("oauthData")?t.extra.oauthData:void 0};return n.googleUser&&n.googleUser.hasOwnProperty("photo_url")&&!n.googleUser.hasOwnProperty("photoUrl")&&(n.googleUser.photoUrl=n.googleUser.photo_url,n.googleUser.auth_provider="google"),t&&t.hasOwnProperty("settings")&&t.settings.hasOwnProperty("oauth_doc_id")&&""!==t.settings.oauth_doc_id&&(n.googleUser.auth_id=t.settings.oauth_doc_id),n},bindListingView:function(t){var e=this;a.ui.footable(t.find(".footable")),a.ui.tooltips(t),t.find(".new-account").on("click",function(){e.renderEditConfiguration()}),t.find(".update-account").on("click",function(){var t=n(this).parents("tr"),a=t.data("id");e.renderEditConfiguration(a)}),t.find(".delete-account").on("click",function(){var t=n(this).parents("tr"),i=t.data("id"),l=t.data("name");a.ui.confirm(e.getTemplate({name:"!"+e.i18n.active().integrationGoogleDrive.confirmDelete,data:{accountName:l}}),function(){e.deleteGoogleDriveAccount(i,function(){o.success(e.getTemplate({name:"!"+e.i18n.active().integrationGoogleDrive.successDelete,data:{accountName:l}})),e.renderListAccounts()})})})},formatGoogleDriveData:function(t){var n={googleDriveAccounts:[]};return e.each(t.attachments,function(t,e){"google_drive"===t.handler&&(t.extra={uuid:e},n.googleDriveAccounts.push(t))}),n},initStorage:function(t){var n=this;n.callApi({resource:"storage.add",data:{accountId:n.accountId,data:{attachments:{}}},success:function(n){t&&t(n.data)}})},saveGoogleDriveConfiguration:function(t,e,o){var i,l=this;t&&l.appFlags.appData.storage.attachments.hasOwnProperty(t)?(i=t,l.appFlags.appData.storage.attachments[i]=n.extend(!0,{},l.appFlags.appData.storage.attachments[t],e)):(i=a.util.guid(),l.appFlags.appData.storage.attachments[i]=n.extend(!0,{},{handler:"google_drive"},e)),l.updateGoogleDriveAccounts(l.appFlags.appData.storage,function(t){o&&o(l.appFlags.appData.storage.attachments[i])})},getConfigurationData:function(t,n){var e,a=this;a.appFlags.appData.storage.attachments.hasOwnProperty(t)&&(e=a.appFlags.appData.storage.attachments[t]),e&&e.hasOwnProperty("settings")&&e.settings.hasOwnProperty("oauth_doc_id")&&""!==e.settings.oauth_doc_id?a.getOAuthInfo(e.settings.oauth_doc_id,function(t){e.extra={oauthData:t},n&&n(e)}):n&&n(e)},updateGoogleDriveAccounts:function(t,n){var e=this;e.callApi({resource:"storage.update",data:{accountId:e.accountId,data:t},success:function(t){n&&n(t.data)}})},patchGoogleDriveAccounts:function(t,n){var e=this;e.callApi({resource:"storage.patch",data:{accountId:e.accountId,data:t},success:function(t){n&&n(t.data)}})},getOAuthInfo:function(t,n){var e=this;e.callApi({resource:"auth.getLink",data:{accountId:e.accountId,auth_id:t},success:function(t){n&&n(t.data)}})},deleteGoogleDriveAccount:function(t,e){var a=this;a.getGoogleDriveAccounts(function(o){var i=n.extend(!0,{},o.attachments[t]);delete o.attachments[t],a.updateGoogleDriveAccounts(o,function(t){e&&e(i)})})},getGoogleDriveAccounts:function(t){var n=this,e=function(e){n.appFlags.appData.storage=e,t&&t(e)};n.callApi({resource:"storage.get",data:{accountId:n.accountId,generateError:!1},success:function(t){e(t.data)},error:function(t,a,o){404===a.status?n.initStorage(function(t){e(t)}):o(t)}})}}}),this.monster=this.monster||{},this.monster.cache=this.monster.cache||{},this.monster.cache.templates=this.monster.cache.templates||{},this.monster.cache.templates["integration-google-drive"]=this.monster.cache.templates["integration-google-drive"]||{},this.monster.cache.templates["integration-google-drive"]._main=this.monster.cache.templates["integration-google-drive"]._main||{},this.monster.cache.templates["integration-google-drive"]._main["edit-configuration"]=Handlebars.template({1:function(t,n,e,a,o){return" edition-mode"},3:function(t,n,e,a,o){return" creation-mode"},compiler:[7,">= 4.0.0"],main:function(t,n,e,a,o){var i,l=t.lambda,r=t.escapeExpression;return'<div class="edit-configuration-wrapper'+(null!=(i=e.if.call(null!=n?n:t.nullContext||{},null!=(i=null!=n?n.configuration:n)?i.name:i,{name:"if",hash:{},fn:t.program(1,o,0),inverse:t.program(3,o,0),data:o}))?i:"")+'">\n\t<form class="form form-horizontal form-inline" id="configuration_form">\n\t\t<div class="header-form">\n\t\t\t<img width="45" src="apps/integration-google-drive/style/static/GoogleDrive_SimpleLogo.png" class="img_style"/>\n\n\t\t\t<div class="text-creation">\n\t\t\t\t<div class="title">'+r(l((i=(i=(i=(i=o&&o.root)&&i.i18n)&&i.integrationGoogleDrive)&&i.edition)&&i.title,n))+'</div>\n\t\t\t</div>\n\n\t\t\t<div class="text-edition">\n\t\t\t\t<div class="title">\n\t\t\t\t\t<span class="configuration-name">'+r(l(null!=(i=null!=n?n.configuration:n)?i.name:i,n))+'</span>\n\t\t\t\t</div>\n\t\t\t\t<div class="subtitle">\n\t\t\t\t\t<span>'+r(l((i=(i=(i=(i=o&&o.root)&&i.i18n)&&i.integrationGoogleDrive)&&i.edition)&&i.subTitle,n))+'</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t\n\n\t\t<div class="content">\n\t\t\t<div class="content-data clearfix">\n\t\t\t\t<div class="content-block">\n\t\t\t\t\t<div class="content-title">'+r(l((i=(i=(i=(i=o&&o.root)&&i.i18n)&&i.integrationGoogleDrive)&&i.edition)&&i.details,n))+'</div>\n\t\t\t\t\t<div class="content-data">\n\t\t\t\t\t\t<div class="control-group">\n\t\t\t\t\t\t\t<label class="control-label">'+r(l((i=(i=(i=(i=(i=o&&o.root)&&i.i18n)&&i.integrationGoogleDrive)&&i.edition)&&i.name)&&i.label,n))+'</label>\n\t\t\t\t\t\t\t<div class="controls">\n\t\t\t\t\t\t\t\t<input required type="text" name="name" value="'+r(l(null!=(i=null!=n?n.configuration:n)?i.name:i,n))+'">\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="control-group">\n\t\t\t\t\t\t\t<label class="control-label">'+r(l((i=(i=(i=(i=(i=o&&o.root)&&i.i18n)&&i.integrationGoogleDrive)&&i.edition)&&i.folder)&&i.label,n))+'</label>\n\t\t\t\t\t\t\t<div class="controls">\n\t\t\t\t\t\t\t\t<input required type="text" name="settings.folder_base_path" value="'+r(l(null!=(i=null!=(i=null!=n?n.configuration:n)?i.settings:i)?i.folder_base_path:i,n))+'">\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<div class="control-group">\n\t\t\t\t\t\t\t<label class="control-label">'+r(l((i=(i=(i=(i=(i=o&&o.root)&&i.i18n)&&i.integrationGoogleDrive)&&i.edition)&&i.oAuthDoc)&&i.label,n))+'</label>\n\t\t\t\t\t\t\t<div class="controls google-field-wrapper"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<div class="content-help clearfix">\n\t\t\t\t<i class="fa fa-question-circle"></i>\n\t\t\t\t<span class="content-help-text">'+r(l((i=(i=(i=(i=o&&o.root)&&i.i18n)&&i.integrationGoogleDrive)&&i.edition)&&i.helpBeforeLink,n))+'</span>\n\t\t\t\t(<a href="https://support.google.com/drive/" target="_blank">https://support.google.com/drive/</a>)\n\t\t\t</div>\n\n\t\t\t<div class="content-actions clearfix">\n\t\t\t\t<div class="pull-right">\n\t\t\t\t\t<button class="monster-button-cancel" id="cancel">'+r(l(null!=(i=null!=n?n.i18n:n)?i.cancel:i,n))+'</button>\n\t\t\t\t\t<button class="monster-button-success" id="save">'+r(l(null!=(i=null!=n?n.i18n:n)?i.saveChanges:i,n))+"</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t</form>\n</div>"},useData:!0}),this.monster.cache.templates["integration-google-drive"]._main["google-field"]=Handlebars.template({1:function(t,n,e,a,o){var i,l=null!=n?n:t.nullContext||{};return(null!=(i=e.if.call(l,null!=n?n.hasGoogleInfo:n,{name:"if",hash:{},fn:t.program(2,o,0),inverse:t.program(5,o,0),data:o}))?i:"")+"\n"+(null!=(i=e.if.call(l,null!=n?n.hasGoogleProvider:n,{name:"if",hash:{},fn:t.program(7,o,0),inverse:t.program(9,o,0),data:o}))?i:"")+'\t\t\t<a class="monster-link monster-blue reset-sso-link" href="javascript:void(0);">'+t.escapeExpression(t.lambda((i=(i=(i=(i=(i=o&&o.root)&&i.i18n)&&i.integrationGoogleDrive)&&i.edition)&&i.googleUser)&&i.reset,n))+"</a>\n"},2:function(t,n,e,a,o){var i;return'\t\t\t\t<div class="user-photo-div-container"></div>\n\t\t\t\t<span class="user-name">\n'+(null!=(i=e.if.call(null!=n?n:t.nullContext||{},null!=n?n.email:n,{name:"if",hash:{},fn:t.program(3,o,0),inverse:t.noop,data:o}))?i:"")+"\t\t\t\t</span>\n"},3:function(t,n,e,a,o){var i;return"\t\t\t\t\t\t"+t.escapeExpression((i=null!=(i=e.email||(null!=n?n.email:n))?i:e.helperMissing,"function"==typeof i?i.call(null!=n?n:t.nullContext||{},{name:"email",hash:{},data:o}):i))+"\n"},5:function(t,n,e,a,o){var i;return'\t\t\t\t<span class="user-name">'+t.escapeExpression(t.lambda((i=(i=(i=(i=(i=o&&o.root)&&i.i18n)&&i.integrationGoogleDrive)&&i.edition)&&i.googleUser)&&i.unknown,n))+"</span>\n"},7:function(t,n,e,a,o){var i;return'\t\t\t\t<a class="monster-link monster-blue populate-link" href="javascript:void(0);">'+t.escapeExpression(t.lambda((i=(i=(i=(i=(i=o&&o.root)&&i.i18n)&&i.integrationGoogleDrive)&&i.edition)&&i.googleUser)&&i.useAnotherAccount,n))+"</a>\n"},9:function(t,n,e,a,o){var i;return'\t\t\t\t<span class="no-provider">'+t.escapeExpression(t.lambda((i=(i=(i=(i=(i=o&&o.root)&&i.i18n)&&i.integrationGoogleDrive)&&i.edition)&&i.googleUser)&&i.noProviders,n))+"</span>\n"},11:function(t,n,e,a,o){var i;return'\t\t\t<span class="user-name">\n\t\t\t\t'+t.escapeExpression(t.lambda((i=(i=(i=(i=(i=o&&o.root)&&i.i18n)&&i.integrationGoogleDrive)&&i.edition)&&i.googleUser)&&i.none,n))+"\n\t\t\t</span>\n"+(null!=(i=e.if.call(null!=n?n:t.nullContext||{},null!=n?n.hasGoogleProvider:n,{name:"if",hash:{},fn:t.program(12,o,0),inverse:t.program(9,o,0),data:o}))?i:"")},12:function(t,n,e,a,o){var i;return'\t\t\t<a class="monster-link monster-blue populate-link" href="javascript:void(0);">'+t.escapeExpression(t.lambda((i=(i=(i=(i=(i=o&&o.root)&&i.i18n)&&i.integrationGoogleDrive)&&i.edition)&&i.googleUser)&&i.sync,n))+"</a>\n"},compiler:[7,">= 4.0.0"],main:function(t,n,e,a,o){var i,l,r=null!=n?n:t.nullContext||{};return'<div class="google-field-container">\n\t<div class="presentation-only user-field">\n'+(null!=(i=e.if.call(r,null!=n?n.isConfigured:n,{name:"if",hash:{},fn:t.program(1,o,0),inverse:t.program(11,o,0),data:o}))?i:"")+'\n\t\t<input required type="hidden" name="settings.oauth_doc_id" value="'+t.escapeExpression((l=null!=(l=e.docId||(null!=n?n.docId:n))?l:e.helperMissing,"function"==typeof l?l.call(r,{name:"docId",hash:{},data:o}):l))+'">\n\t</div>\n</div>\n\n'},useData:!0}),this.monster.cache.templates["integration-google-drive"]._main.layout=Handlebars.template({1:function(t,n,e,a,o){var i,l=t.lambda,r=t.escapeExpression;return'\t\t<div class="list-accounts-wrapper">\n\t\t\t<div class="list-title">'+r(l(null!=(i=null!=(i=null!=(i=null!=n?n.i18n:n)?i.integrationGoogleDrive:i)?i.table:i)?i.title:i,n))+'</div>\n\t\t\t<div class="list-accounts">\n\t\t\t\t<div class="monster-table-wrapper">\n\t\t\t\t\t<div class="monster-table-header">\n\t\t\t\t\t\t<button class="monster-button-primary new-account">\n\t\t\t\t\t\t\t'+r(l(null!=(i=null!=(i=null!=(i=null!=n?n.i18n:n)?i.integrationGoogleDrive:i)?i.table:i)?i.newAccount:i,n))+'\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t\t<table class="monster-table footable">\n\t\t\t\t\t\t<thead>\n\t\t\t\t\t\t\t<tr>\n\t\t\t\t\t\t\t\t<th>'+r(l(null!=(i=null!=(i=null!=(i=null!=n?n.i18n:n)?i.integrationGoogleDrive:i)?i.table:i)?i.accountName:i,n))+'</th>\n\t\t\t\t\t\t\t\t<th data-breakpoints="xs" data-type="html">'+r(l(null!=(i=null!=(i=null!=(i=null!=n?n.i18n:n)?i.integrationGoogleDrive:i)?i.table:i)?i.actions:i,n))+"</th>\n\t\t\t\t\t\t\t</tr>\n\t\t\t\t\t\t</thead>\n\t\t\t\t\t\t<tbody>\n"+(null!=(i=e.each.call(null!=n?n:t.nullContext||{},null!=n?n.googleDriveAccounts:n,{name:"each",hash:{},fn:t.program(2,o,0),inverse:t.noop,data:o}))?i:"")+"\t\t\t\t\t\t</tbody>\n\t\t\t\t\t</table>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n"},2:function(t,n,e,a,o){var i,l,r=t.lambda,s=t.escapeExpression,c=null!=n?n:t.nullContext||{},u=e.helperMissing;return'\t\t\t\t\t\t\t\t<tr data-id="'+s(r(null!=(i=null!=n?n.extra:n)?i.uuid:i,n))+'" data-name="'+s((l=null!=(l=e.name||(null!=n?n.name:n))?l:u,"function"==typeof l?l.call(c,{name:"name",hash:{},data:o}):l))+'">\n\t\t\t\t\t\t\t\t\t<td>'+s((l=null!=(l=e.name||(null!=n?n.name:n))?l:u,"function"==typeof l?l.call(c,{name:"name",hash:{},data:o}):l))+'</td>\n\t\t\t\t\t\t\t\t\t<td>\n\t\t\t\t\t\t\t\t\t\t<i class="action-link update-account fa fa-cog" data-toggle="tooltip" data-placement="top" data-original-title="'+s(r((i=(i=(i=(i=o&&o.root)&&i.i18n)&&i.integrationGoogleDrive)&&i.table)&&i.editTooltip,n))+'"></i>\n\t\t\t\t\t\t\t\t\t\t<i class="action-link delete-account fa fa-trash-o" data-toggle="tooltip" data-placement="top" data-original-title="'+s(r((i=(i=(i=(i=o&&o.root)&&i.i18n)&&i.integrationGoogleDrive)&&i.table)&&i.deleteTooltip,n))+'"></i>\n\t\t\t\t\t\t\t\t\t</td>\n\t\t\t\t\t\t\t\t</tr>\n'},4:function(t,n,e,a,o){var i;return'\t\t<div class="no-accounts-wrapper new-account">\n\t\t\t<i class="fa fa-plus-circle"></i>\n\t\t\t<span class="no-accounts-text">'+t.escapeExpression(t.lambda(null!=(i=null!=(i=null!=n?n.i18n:n)?i.integrationGoogleDrive:i)?i.noAccount:i,n))+"</span>\n\t\t</div>\n"},compiler:[7,">= 4.0.0"],main:function(t,n,e,a,o){var i,l=t.lambda,r=t.escapeExpression;return'<div id="integration-google-drive_listing_wrapper">\n\t<div class="title-bar-wrapper">\n\t\t<div class="title-logo">\n\t\t\t<svg class="integration-logo"><use xlink:href="#g-drive--color" /></svg>\n\t\t</div>\n\t\t<div class="title-text">'+r(l(null!=(i=null!=(i=null!=n?n.i18n:n)?i.integrationGoogleDrive:i)?i.title:i,n))+'</div>\n\t\t<div class="title-subtext">'+r(l(null!=(i=null!=(i=null!=n?n.i18n:n)?i.integrationGoogleDrive:i)?i.description:i,n))+"</div>\n\t</div>\n\n"+(null!=(i=e.if.call(null!=n?n:t.nullContext||{},null!=(i=null!=n?n.googleDriveAccounts:n)?i.length:i,{name:"if",hash:{},fn:t.program(1,o,0),inverse:t.program(4,o,0),data:o}))?i:"")+"</div>\n"},useData:!0});