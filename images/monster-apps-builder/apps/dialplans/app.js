define("apps/dialplans/app",["require","jquery","lodash","monster","chosen","toastr"],function(n){var t=n("jquery"),e=n("lodash"),a=n("monster"),i=(n("chosen"),n("toastr"));return{name:"dialplans",css:["app"],i18n:{"en-US":{customCss:!1}},requests:{},subscribe:{},appFlags:{systemDialplans:void 0},load:function(n){var t=this;t.initApp(function(){n&&n(t)})},initApp:function(n){var t=this;a.pub("auth.initApp",{app:t,callback:n})},render:function(n){var t=this;t.getSystemSettings(function(n){t.appFlags.systemDialplans=n,a.ui.generateAppLayout(t,{appName:t.i18n.active().dialplans.title,menus:[{tabs:[{text:t.i18n.active().dialplans.menuTitles.account,callback:t.renderAccountDialplans},{text:t.i18n.active().dialplans.menuTitles.user,callback:t.renderUserDialplans},{text:t.i18n.active().dialplans.menuTitles.device,callback:t.renderDeviceDialplans}]}]})})},renderAccountDialplans:function(n){var e=this,s=n||{},l=s.container||t("#dialplans_app_container .app-content-wrapper");e.getAccount(e.accountId,function(n){var s=t(a.template(e,"accounts")),c=function(n){l.find(".dialplan-settings").empty();var t={id:e.accountId,dial_plan:n};e.updateAccountDialplan(t,function(n){i.success(e.i18n.active().dialplans.successUpdate),e.renderDialplanSettings(s,n.dial_plan,c)})};e.renderDialplanSettings(s,n.dial_plan,c),l.fadeOut(function(){t(this).empty().append(s).fadeIn()})})},renderUserDialplans:function(n){var i=this,s=n||{},l=s.container||t("#dialplans_app_container .app-content-wrapper");i.listUsers(function(n){e.each(n,function(n){n.name=n.first_name+" "+n.last_name});var s=t(a.template(i,"users"));i.renderSelector(s,n),i.bindUserDialplans(s),l.fadeOut(function(){t(this).empty().append(s).fadeIn()})})},getDialplanSettings:function(n){var e={system:[]};return n.find(".system-select:checked").each(function(){e.system.push(t(this).data("type"))}),n.find(".dialplan-rule").each(function(){var n=t(this),a={regex:n.find(".regex").val(),suffix:n.find(".suffix").val(),prefix:n.find(".prefix").val(),description:n.hasClass("new")?n.find(".description").val():n.find(".description").data("name")};a.regex&&"system"!==a.regex&&(e[a.regex]={description:a.description},a.prefix&&(e[a.regex].prefix=a.prefix),a.suffix&&(e[a.regex].suffix=a.suffix))}),e},bindUserDialplans:function(n){var e=this;n.find("#select_entity").on("change",function(){n.find(".dialplan-settings").empty();var a=t(this).val();e.getUser(a,function(t){var s=function(t){n.find(".dialplan-settings").empty();var l={id:a,dial_plan:t};e.updateUserDialplan(l,function(t){i.success(e.i18n.active().dialplans.successUpdate),e.renderDialplanSettings(n,t.dial_plan,s)})};e.renderDialplanSettings(n,t.dial_plan,s)})})},renderDeviceDialplans:function(n){var e=this,i=n||{},s=i.container||t("#dialplans_app_container .app-content-wrapper");e.listDevices(function(n){var i=t(a.template(e,"devices"));e.renderSelector(i,n),e.bindDeviceDialplans(i),s.fadeOut(function(){t(this).empty().append(i).fadeIn()})})},bindDeviceDialplans:function(n){var e=this;n.find("#select_entity").on("change",function(){n.find(".dialplan-settings").empty();var a=t(this).val();e.getDevice(a,function(t){var s=function(t){n.find(".dialplan-settings").empty();var l={id:a,dial_plan:t};e.updateDeviceDialplan(l,function(t){i.success(e.i18n.active().dialplans.successUpdate),e.renderDialplanSettings(n,t.dial_plan,s)})};e.renderDialplanSettings(n,t.dial_plan,s)})})},renderDialplanSettings:function(n,i,s){var l=this,c=l.formatDialplanData(i),r=t(a.template(l,"dialplan-settings",c));e.each(i,function(n,t){"system"!==t&&(n.regex=t,r.find(".dialplan-rules").append(a.template(l,"dialplan-rule",n)))}),l.bindDialplanSettings(r,s),n.find(".dialplan-settings").empty().append(r)},bindDialplanSettings:function(n,e){var i=this,s=function(n,t){var e,a=t.exec(n);if(a.length>1){a.shift();for(var i="",s=0;s<a.length;s++)a[s].length>i.length&&(i=a[s]);e=i}else e=a[0];return e},l=function(n){var t,e=n.find(".prefix").val(),a=n.find(".suffix").val(),i=n.find(".number-test").val(),l=n.find(".regex").val(),c=function(){n.find(".result-testing.failure").show(),n.find(".result-testing.success").hide(),n.find(".result-testing-container").show()};if(""===i)n.find(".result-testing-container").hide();else try{t=new RegExp(l),t.test(i)?function(t){var l=s(i,t);n.find(".result-testing.failure").hide(),n.find(".formatted-number").html(e+l+a),n.find(".result-testing.success").show(),n.find(".result-testing-container").show()}(t):c()}catch(n){c()}};n.find(".add-rule").on("click",function(){n.find(".dialplan-rules").append(a.template(i,"dialplan-rule"))}),n.find(".dialplan-rules").on("click",".delete-rule",function(){t(this).parents(".dialplan-rule").remove()}),n.find(".save-dialplan-settings").on("click",function(){var t=i.getDialplanSettings(n);e&&e(t)}),n.find(".dialplan-rules").on("keyup",".number-test, .prefix, .suffix, .regex",function(n){l(t(this).parents(".dialplan-rule"))})},renderSelector:function(n,e){var i=this,s=t(a.template(i,"entitySelector",{entities:e}));s.find("select").chosen({search_contains:!0,width:"220px",placeholder_text_single:i.i18n.active().dialplans.entities.none}),n.find(".selector").append(s)},formatDialplanData:function(n){var t=this,a={systemDialplans:[],dialPlans:{}},i=n&&n.hasOwnProperty("system")?n.system:[];return e.each(n,function(n,t){"system"!==t&&(a.dialPlans[t]=n)}),e.each(t.appFlags.systemDialplans,function(n){var t={name:n.name,checked:i.indexOf(n.name)>=0};a.systemDialplans.push(t)}),a},getSystemSettings:function(n){var t=this;t.callApi({resource:"system.dialplans",data:{accountId:t.accountId},success:function(t){n&&n(t.data)}})},getAccount:function(n,t){this.callApi({resource:"account.get",data:{accountId:n},success:function(n){t&&t(n.data)}})},updateAccountDialplan:function(n,t){var e=this;e.getAccount(n.id,function(a){a.dial_plan=n.dial_plan,e.updateAccount(a,function(n){t&&t(n)})})},updateAccount:function(n,t){this.callApi({resource:"account.update",data:{accountId:n.id,data:n},success:function(n){t&&t(n.data)}})},getUser:function(n,t){var e=this;e.callApi({resource:"user.get",data:{accountId:e.accountId,userId:n},success:function(n){t&&t(n.data)}})},updateUserDialplan:function(n,t){var e=this;e.getUser(n.id,function(a){a.dial_plan=n.dial_plan,e.updateUser(a,function(n){t&&t(n)})})},updateUser:function(n,t){var e=this;e.callApi({resource:"user.update",data:{accountId:e.accountId,data:n},success:function(n){t&&t(n.data)}})},listUsers:function(n){var t=this;t.callApi({resource:"user.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t){n&&n(t.data)}})},getDevice:function(n,t){var e=this;e.callApi({resource:"device.get",data:{accountId:e.accountId,deviceId:n},success:function(n){t&&t(n.data)}})},updateDeviceDialplan:function(n,t){var e=this;e.getDevice(n.id,function(a){a.dial_plan=n.dial_plan,e.updateDevice(a,function(n){t&&t(n)})})},updateDevice:function(n,t){var e=this;e.callApi({resource:"device.update",data:{accountId:e.accountId,data:n},success:function(n){t&&t(n.data)}})},listDevices:function(n){var t=this;t.callApi({resource:"device.list",data:{accountId:t.accountId,filters:{paginate:!1}},success:function(t){n&&n(t.data)}})}}}),this.monster=this.monster||{},this.monster.cache=this.monster.cache||{},this.monster.cache.templates=this.monster.cache.templates||{},this.monster.cache.templates.dialplans=this.monster.cache.templates.dialplans||{},this.monster.cache.templates.dialplans._main=this.monster.cache.templates.dialplans._main||{},this.monster.cache.templates.dialplans._main.accounts=Handlebars.template({compiler:[7,">= 4.0.0"],main:function(n,t,e,a,i){return'<div class="accounts-dialplan dialplan-wrapper">\n\t<div class="dialplan-settings">\n\n\t</div>\n</div>'},useData:!0}),this.monster.cache.templates.dialplans._main.devices=Handlebars.template({compiler:[7,">= 4.0.0"],main:function(n,t,e,a,i){return'<div class="devices-dialplan dialplan-wrapper">\n\t<div class="selector">\n\n\t</div>\n\n\t<div class="dialplan-settings">\n\n\t</div>\n</div>'},useData:!0}),this.monster.cache.templates.dialplans._main["dialplan-rule"]=Handlebars.template({1:function(n,t,e,a,i){return" new"},3:function(n,t,e,a,i){var s,l=null!=t?t:n.nullContext||{},c=e.helperMissing,r=n.escapeExpression;return'\t\t<h5 class="description" data-name="'+r((s=null!=(s=e.description||(null!=t?t.description:t))?s:c,"function"==typeof s?s.call(l,{name:"description",hash:{},data:i}):s))+'">'+r((s=null!=(s=e.description||(null!=t?t.description:t))?s:c,"function"==typeof s?s.call(l,{name:"description",hash:{},data:i}):s))+"</h5>\n"},5:function(n,t,e,a,i){var s;return'\t\t<div class="description-wrapper">\n\t\t\t<label>'+n.escapeExpression(n.lambda((s=(s=(s=(s=i&&i.root)&&s.i18n)&&s.dialplans)&&s.custom)&&s.description,t))+'</label>\n\t\t\t<input class="description" type="text" name="description">\n\t\t</div>\n'},compiler:[7,">= 4.0.0"],main:function(n,t,e,a,i){var s,l,c=null!=t?t:n.nullContext||{},r=n.lambda,u=n.escapeExpression,d=e.helperMissing;return'<div class="dialplan-rule clearfix'+(null!=(s=e.unless.call(c,null!=t?t.description:t,{name:"unless",hash:{},fn:n.program(1,i,0),inverse:n.noop,data:i}))?s:"")+'">\n'+(null!=(s=e.if.call(c,null!=t?t.description:t,{name:"if",hash:{},fn:n.program(3,i,0),inverse:n.program(5,i,0),data:i}))?s:"")+'\n\t<div class="regex-field">\n\t\t<label>'+u(r((s=(s=(s=(s=i&&i.root)&&s.i18n)&&s.dialplans)&&s.custom)&&s.regex,t))+'</label>\n\t\t<input class="regex" type="text" name="regex" value="'+u((l=null!=(l=e.regex||(null!=t?t.regex:t))?l:d,"function"==typeof l?l.call(c,{name:"regex",hash:{},data:i}):l))+'">\n\t</div>\n\n\t<div class="stacked-fields">\n\t\t<div>\n\t\t\t<label>'+u(r((s=(s=(s=(s=i&&i.root)&&s.i18n)&&s.dialplans)&&s.custom)&&s.prefix,t))+'</label>\n\t\t\t<input class="input-small prefix" type="text" name="prefix" value="'+u((l=null!=(l=e.prefix||(null!=t?t.prefix:t))?l:d,"function"==typeof l?l.call(c,{name:"prefix",hash:{},data:i}):l))+'">\n\t\t</div>\n\n\t\t<div>\n\t\t\t<label>'+u(r((s=(s=(s=(s=i&&i.root)&&s.i18n)&&s.dialplans)&&s.custom)&&s.suffix,t))+'</label>\n\t\t\t<input class="input-small suffix" type="text" name="suffix" value="'+u((l=null!=(l=e.suffix||(null!=t?t.suffix:t))?l:d,"function"==typeof l?l.call(c,{name:"suffix",hash:{},data:i}):l))+'">\n\t\t</div>\n\t</div>\n\n\t<div class="testing">\n\t\t<input type="text" class="input-medium number-test" name="extra.testing" autocomplete="off" placeholder="'+u(r((s=(s=(s=(s=(s=i&&i.root)&&s.i18n)&&s.dialplans)&&s.custom)&&s.testing)&&s.testPlaceholder,t))+'">\n\n\t\t<div class="result-testing-container">\n\t\t\t<span>'+u(r((s=(s=(s=(s=(s=i&&i.root)&&s.i18n)&&s.dialplans)&&s.custom)&&s.testing)&&s.title,t))+'</span>\n\n\t\t\t<span class="result-testing success">\n\t\t\t\t<span><i class="monster-green fa fa-check"></i>'+u(r((s=(s=(s=(s=(s=i&&i.root)&&s.i18n)&&s.dialplans)&&s.custom)&&s.testing)&&s.success,t))+'</span>\n\t\t\t\t<div class="formatted-number-wrapper">\n\t\t\t\t\t<div class="formatted-number-title">'+u(r((s=(s=(s=(s=(s=i&&i.root)&&s.i18n)&&s.dialplans)&&s.custom)&&s.testing)&&s.formattedNumber,t))+'</div>\n\t\t\t\t\t<div class="formatted-number"></div>\n\t\t\t\t</div>\n\t\t\t</span>\n\n\t\t\t<span class="result-testing failure">\n\t\t\t\t<i class="fa fa-ban monster-red"></i>'+u(r((s=(s=(s=(s=(s=i&&i.root)&&s.i18n)&&s.dialplans)&&s.custom)&&s.testing)&&s.failure,t))+'\n\t\t\t</span>\n\t\t</div>\n\t</div>\n\n\t<div class="actions-rule">\n\t\t<button class="delete-rule monster-button-danger"><i class="fa fa-trash"></i>'+u(r((s=(s=i&&i.root)&&s.i18n)&&s.delete,t))+"</i></button>\n\t</div>\n</div>"},useData:!0}),this.monster.cache.templates.dialplans._main["dialplan-settings"]=Handlebars.template({1:function(n,t,e,a,i){var s;return'\t\t\t<div class="system-rule">\n'+(null!=(s=(e.monsterCheckbox||t&&t.monsterCheckbox||e.helperMissing).call(null!=t?t:n.nullContext||{},null!=t?t.name:t,{name:"monsterCheckbox",hash:{},fn:n.program(2,i,0),inverse:n.noop,data:i}))?s:"")+"\t\t\t</div>\n"},2:function(n,t,e,a,i){var s,l,c=null!=t?t:n.nullContext||{};return'\t\t\t\t\t<input data-type="'+n.escapeExpression((l=null!=(l=e.name||(null!=t?t.name:t))?l:e.helperMissing,"function"==typeof l?l.call(c,{name:"name",hash:{},data:i}):l))+'" class="system-select" type="checkbox"'+(null!=(s=e.if.call(c,null!=t?t.checked:t,{name:"if",hash:{},fn:n.program(3,i,0),inverse:n.noop,data:i}))?s:"")+"/>\n"},3:function(n,t,e,a,i){return" checked"},5:function(n,t,e,a,i){var s;return"\t\t\t"+n.escapeExpression(n.lambda(null!=(s=null!=(s=null!=(s=null!=t?t.i18n:t)?s.dialplans:s)?s.system:s)?s.noRules:s,t))+"\n"},compiler:[7,">= 4.0.0"],main:function(n,t,e,a,i){var s,l=n.lambda,c=n.escapeExpression;return'\n<div class="diaplan-settings">\n\t<div class="system-rules">\n\t\t<h3>'+c(l(null!=(s=null!=(s=null!=(s=null!=t?t.i18n:t)?s.dialplans:s)?s.system:s)?s.title:s,t))+"</h3>\n"+(null!=(s=e.each.call(null!=t?t:n.nullContext||{},null!=t?t.systemDialplans:t,{name:"each",hash:{},fn:n.program(1,i,0),inverse:n.program(5,i,0),data:i}))?s:"")+'\t</div>\n\n\t<div class="rules">\n\t\t<h3>'+c(l(null!=(s=null!=(s=null!=(s=null!=t?t.i18n:t)?s.dialplans:s)?s.custom:s)?s.title:s,t))+'</h3>\n\n\t\t<div class="dialplan-rules">\n\n\t\t</div>\n\n\t\t<div class="add-rule">\n\t\t\t<button class="monster-button-primary"><i class="fa fa-plus"></i>'+c(l(null!=(s=null!=t?t.i18n:t)?s.add:s,t))+'</button>\n\t\t</div>\n\t</div>\n\n\t<div class="actions">\n\t\t<button class="save-dialplan-settings monster-button-success">'+c(l(null!=(s=null!=t?t.i18n:t)?s.save:s,t))+"</button>\n\t</div>\n</div>"},useData:!0}),this.monster.cache.templates.dialplans._main.entitySelector=Handlebars.template({1:function(n,t,e,a,i){var s,l=null!=t?t:n.nullContext||{},c=e.helperMissing,r=n.escapeExpression;return'\t\t\t\t<option value="'+r((s=null!=(s=e.id||(null!=t?t.id:t))?s:c,"function"==typeof s?s.call(l,{name:"id",hash:{},data:i}):s))+'">'+r((s=null!=(s=e.name||(null!=t?t.name:t))?s:c,"function"==typeof s?s.call(l,{name:"name",hash:{},data:i}):s))+"</option>\n"},compiler:[7,">= 4.0.0"],main:function(n,t,e,a,i){var s;return'<div class="entity-selector-wrapper">\n\t<div class="entity-selector">\n\t\t<select id="select_entity">\n\t\t\t<option value="none"></option>\n'+(null!=(s=e.each.call(null!=t?t:n.nullContext||{},null!=t?t.entities:t,{name:"each",hash:{},fn:n.program(1,i,0),inverse:n.noop,data:i}))?s:"")+"\t\t</select>\n\t</div>\n</div>"},useData:!0}),this.monster.cache.templates.dialplans._main.users=Handlebars.template({compiler:[7,">= 4.0.0"],main:function(n,t,e,a,i){return'<div class="users-dialplan dialplan-wrapper">\n\t<div class="selector">\n\n\t</div>\n\n\t<div class="dialplan-settings">\n\n\t</div>\n</div>'},useData:!0});