define("apps/callqueues-reporting/app",["require","jquery","lodash","chart","moment","randomColor","monster"],function(t){var e=t("jquery"),a=t("lodash"),n=t("chart"),s=t("moment"),i=t("randomColor"),l=t("monster");return{name:"callqueues-reporting",css:["app"],i18n:{"en-US":{customCss:!1},"fr-FR":{customCss:!1}},requests:{},subscribe:{},appflags:{reportingsInception:[2017,0,1],defaultEntity:"queues",defaultPeriod:"monthly",periods:{daily:{unit:"day",mask:"YYYYMMDD",offset:7,format:function(t){return l.util.toFriendlyDate(t.toDate(),"date")}},monthly:{unit:"month",mask:"YYYYMM",offset:6,format:function(t){return t.format("MMM YYYY")}}},hues:["blue","green","red","monochrome","orange","pink","purple","yellow"],measures:{amount:{getData:function(t){return{backgroundColor:t,type:"bar"}}},time:{getData:function(t){return{borderColor:t,fill:!1,pointBackgroundColor:t,pointRadius:5,type:"line"}}}},entities:{queues:[{id:"abandon_count",measure:"amount"},{id:"avg_wait",measure:"time"},{id:"call_count",measure:"amount"},{id:"timeout_count",measure:"amount"}]}},load:function(t){var e=this;e.initApp(function(){t&&t(e)})},initApp:function(t){var e=this;l.pub("auth.initApp",{app:e,callback:t})},render:function(t){var e=this;a.forEach(e.appflags.entities,function(t,n){e.appflags[n]=a.merge({period:e.appflags.defaultPeriod},e.utilGenerateRangeByPeriod(e.appflags.defaultPeriod))}),l.ui.generateAppLayout(e,{menus:[{tabs:[{callback:e.renderLayout}]}]})},renderLayout:function(t){var n=this,s=function(t){var s=e(n.getTemplate({name:"layout",data:{entities:a.map(n.appflags.entities,function(t,e){return{id:e,label:n.i18n.active().callQueuesReportingApp.misc.entities[e].label}})}}));return a.forEach(n.appflags.entities,function(e,a){n.renderDashboard(s,a,t[a]||{})}),s.find(".nav-tabs a[href^="+n.appflags.defaultEntity+"]").tab("show"),s},i=function(t){var e={};return a.forEach(t,function(t,s){e[s]=function(e){l.waterfall([function(t){n["requestList"+a.capitalize(s)]({success:function(e){t(null,e)}})},function(e,i){n.requestGetReport({data:{data:{report:s,metrics:a.map(t,"id"),identifiers:a.chain(e).map("id").slice(0,1).value()}},success:function(t){i(null,e,t)}})}],function(t,a,n){e(null,{list:a,report:n})})}}),e};l.ui.insertTemplate(t.container,function(t){l.parallel(i(n.appflags.entities),function(e,a){t(s(a))})})},renderDashboard:function(t,n,i){var r=this,o="#"+n+"_content",c=r.appflags[n],u=function(){var t=e(r.getTemplate({name:"dashboard",data:p()})),a=function(e){l.ui.datepicker(t.find("#"+e),{maxDate:c.endDate.toDate(),minDate:s(r.appflags.reportingsInception).toDate()}),t.find("#"+e).datepicker("setDate",c[e].toDate())};return a("startDate"),a("endDate"),r.helperCreateChart(t,n,i.report),r.bindDashboardEvents(t,n),t},p=function(){return{type:n,periods:{selected:r.appflags.defaultPeriod,list:a.map(r.appflags.periods,function(t,e){return{id:e,name:r.i18n.active().callQueuesReportingApp.misc.periods[e]}})},metrics:{selected:i.report.metrics,list:a.map(r.appflags.entities[n],function(t){return{id:t.id,name:r.i18n.active().callQueuesReportingApp.misc.metrics[t.id]}})},entities:{selected:i.report.entities,list:i.list}}};l.ui.insertTemplate(t.find(o),function(t){t(u())})},bindDashboardEvents:function(t,n){var i=this,r=i.appflags[n];t.find(".period-select").on("change",function(e){e.preventDefault();var s=e.target.value;r.period!==s&&(a.merge(r,i.utilGenerateRangeByPeriod(s),{period:s}),t.find("#startDate").datepicker("setDate",r.startDate.toDate()),t.find("#endDate").datepicker("setDate",r.endDate.toDate()),i.helperEmptyChart(t,n))}),t.find(".date-input").datepicker("option","onSelect",function(a,l){var o=s(e(this).datepicker("getDate")),c=l.id;r[c].diff(o)&&(r[c]=o,i.helperEmptyChart(t,n))}),t.find(".add-metric").on("click",function(e){e.preventDefault();var s=l.ui.getFormData(n+"_filters_form");a.isEmpty(s.metrics)||a.isEmpty(s.entities)||i.helperAddDatasets(t,n,s)}),t.find(".remove-metric").on("click",function(e){e.preventDefault();var s=l.ui.getFormData(n+"_filters_form");a.isEmpty(s.datasets)||i.helperRemoveDatasets(t,n,s.datasets)})},helperCreateChart:function(t,e,s){var i=this;n.plugins.register({afterDraw:function(t){if(0===t.data.datasets.length){var e=t.chart.ctx,a=t.chart.width,n=t.chart.height;t.clear(),e.save(),e.textAlign="center",e.textBaseline="middle",e.font='16px normal "Helvetica Nueue"',e.fillText(i.i18n.active().callQueuesReportingApp.chart.noData,a/2,n/2),e.restore()}}}),i.appflags[e].chart=new n(t.find(".chart"),{type:"bar",options:{responsive:!0,legend:{display:!1},tooltips:{mode:"index",intersect:!0},scales:{xAxes:[{stacked:!0,ticks:{callback:function(t){return i.appflags.periods[i.appflags[e].period].format(t)}}}],yAxes:[{id:"amount",position:"left",ticks:{min:0},stacked:!0},{id:"time",position:"right",ticks:{callback:function(t){return a.round(t,2)+"s"},min:0}}]}}}),i.helperAddDatasets(t,e,s)},helperUpdateChart:function(t,e){var n=this,s=n.appflags[t].chart;!function(t){var e=a.map(t.data.datasets,"yAxisID");a.forEach(t.options.scales.yAxes,function(t){t.display=a.includes(e,t.id)})}(s),function(t){t.data.datasets=a.chain(t.data.datasets).groupBy("type").map(function(t,e){return{type:e,datasets:a.orderBy(t,function(t){return a.reduce(t.data,function(t,e){return t+(a.isNaN(e)?0:e)},0)},"desc")}}).orderBy("type","desc").map("datasets").flatten().value()}(s),function(t,e){e&&a.isEmpty(t.data.labels)&&(t.data.labels=e)}(s,e),s.update()},helperEmptyChart:function(t,e){var n=this,s=n.appflags[e].chart;s.data.labels=[],n.helperRemoveDatasets(t,e,a.map(s.data.datasets,function(t){return t.metadata.entityId+"."+t.metadata.metric}))},helperAddDatasets:function(t,n,s){var i=this,l=i.appflags[n].chart,r=function(s){var r,o,c;a.isEmpty(s.datasets)||(a.forEach(s.datasets,function(s){o=s.metadata.entityId,c=s.metadata.metric,a.find(l.data.datasets,{metadata:s.metadata})||(l.data.datasets.push(s),r=e("<option>").prop({value:o+"."+c,text:i.i18n.active().callQueuesReportingApp.misc.metrics[c],style:"color: "+s["line"===s.type?"borderColor":"backgroundColor"]}),t.find("#"+n+'_datasets_select optgroup[id="'+o+'"]').length||t.find("#"+n+"_datasets_select").append(e("<optgroup>").prop({label:i.appflags[n].list[o],id:o})),t.find("#"+n+'_datasets_select optgroup[id="'+o+'"]').append(r))}),i.helperUpdateChart(n,s.labels))},o=function(){var e=["entities-select","metrics-select","period-select","datasets-select","date-input"];a.forEach(e,function(e){var a=t.find("."+e);a.prop("disabled",!a.prop("disabled"))})};s.hasOwnProperty("labels")?r(s):(o(),i.requestGetReport({data:{data:{report:n,metrics:s.metrics,identifiers:s.entities}},success:function(t){r(t),o()},error:function(){o()}}))},helperRemoveDatasets:function(t,e,n){var s,i,l,r=this;a.forEach(n,function(n){s=a.split(n,"."),i=a.head(s),l=a.last(s),a.remove(r.appflags[e].chart.data.datasets,{metadata:{entityId:i,metric:l}}),t.find("#"+e+'_datasets_select option[value="'+n+'"]').remove(),t.find("#"+e+'_datasets_select optgroup[id="'+i+'"]').is(":empty")&&t.find("#"+e+'_datasets_select optgroup[id="'+i+'"]').remove()}),r.helperUpdateChart(e)},helperFormatDatasets:function(t,e,n){var i,l=this,r=l.appflags.periods[l.appflags[n].period],o=function(t,e){var n=t.endDate.diff(t.startDate,e),i=[t.startDate];return a.times(n,function(){i.push(s(a.last(i)).add(1,e))}),i}(l.appflags[n],r.unit),c=l.utilGenerateColorsPerMetric(t.length,e.metrics),u=[];return a.forEach(t,function(t,e){a.forEach(t.data,function(e,s){i=a.find(l.appflags.entities[n],{id:s}).measure,u.push(a.merge({label:l.appflags[n].list[t.id]+"-"+l.i18n.active().callQueuesReportingApp.misc.metrics[s],yAxisID:i,data:a.map(o,function(t){var a=t.format(r.mask);return e.hasOwnProperty(a)?e[a]:NaN}),metadata:{entityId:t.id,metric:s}},l.appflags.measures[i].getData(c[s].pop())))})}),{entities:e.identifiers,metrics:e.metrics,datasets:u,labels:o}},utilGenerateColorsPerMetric:function(t,e){var n=this,s=a.shuffle(n.appflags.hues),l=e.length,r=s.length;return a.transform(e,function(e,a,n){e[a]=i({count:t,hue:1!==l?s[n%r]:void 0})},{})},utilGenerateRangeByPeriod:function(t){var e=this,a=e.appflags.periods[t],n=s().startOf("day").subtract(1,"day");return{startDate:s(n).subtract(a.offset,a.unit),endDate:n}},utilDateToIso8601:function(t){return t.format("YYYY-MM-DD")},requestListQueues:function(t){var e=this;e.callApi({resource:"qubicleQueues.list",data:a.merge({accountId:e.accountId},t.data),success:function(n,s){e.appflags.queues.list=a.transform(n.data,function(t,e){t[e.id]=e.name},{}),t.hasOwnProperty("success")&&t.success(a.sortBy(n.data,"name"))},error:function(e){t.hasOwnProperty("error")&&t.error(e)}})},requestGetReport:function(t){var e=this,n=t.data.data.report,s=e.appflags[n];e.callApi({resource:"qubicleReports.get",data:a.merge({accountId:e.accountId,data:{period:s.period,start_date:e.utilDateToIso8601(s.startDate),end_date:e.utilDateToIso8601(s.endDate)}},t.data),success:function(a,s){t.hasOwnProperty("success")&&t.success(e.helperFormatDatasets(a.data.report,t.data.data,n))},error:function(e){t.hasOwnProperty("error")&&t.error(e)}})}}}),this.monster=this.monster||{},this.monster.cache=this.monster.cache||{},this.monster.cache.templates=this.monster.cache.templates||{},this.monster.cache.templates["callqueues-reporting"]=this.monster.cache.templates["callqueues-reporting"]||{},this.monster.cache.templates["callqueues-reporting"]._main=this.monster.cache.templates["callqueues-reporting"]._main||{},this.monster.cache.templates["callqueues-reporting"]._main.dashboard=Handlebars.template({1:function(t,e,a,n,s){var i;return null!=(i=(a.select||e&&e.select||a.helperMissing).call(null!=e?e:t.nullContext||{},null!=e?e.selected:e,{name:"select",hash:{},fn:t.program(2,s,0),inverse:t.noop,data:s}))?i:""},2:function(t,e,a,n,s){var i;return null!=(i=a.each.call(null!=e?e:t.nullContext||{},null!=e?e.list:e,{name:"each",hash:{},fn:t.program(3,s,0),inverse:t.noop,data:s}))?i:""},3:function(t,e,a,n,s){var i,l=null!=e?e:t.nullContext||{},r=a.helperMissing,o=t.escapeExpression;return'\t\t\t\t\t<option value="'+o((i=null!=(i=a.id||(null!=e?e.id:e))?i:r,"function"==typeof i?i.call(l,{name:"id",hash:{},data:s}):i))+'">'+o((i=null!=(i=a.name||(null!=e?e.name:e))?i:r,"function"==typeof i?i.call(l,{name:"name",hash:{},data:s}):i))+"</option>\n"},5:function(t,e,a,n,s){var i;return null!=(i=(a.select||e&&e.select||a.helperMissing).call(null!=e?e:t.nullContext||{},null!=e?e.selected:e,{name:"select",hash:{},fn:t.program(6,s,0),inverse:t.noop,data:s}))?i:""},6:function(t,e,a,n,s){var i;return null!=(i=a.each.call(null!=e?e:t.nullContext||{},null!=e?e.list:e,{name:"each",hash:{},fn:t.program(7,s,0),inverse:t.noop,data:s}))?i:""},7:function(t,e,a,n,s){var i,l=null!=e?e:t.nullContext||{},r=a.helperMissing,o=t.escapeExpression;return'\t\t\t\t\t\t\t<option value="'+o((i=null!=(i=a.id||(null!=e?e.id:e))?i:r,"function"==typeof i?i.call(l,{name:"id",hash:{},data:s}):i))+'">'+o((i=null!=(i=a.name||(null!=e?e.name:e))?i:r,"function"==typeof i?i.call(l,{name:"name",hash:{},data:s}):i))+"</option>\n"},compiler:[7,">= 4.0.0"],main:function(t,e,a,n,s){var i,l,r=null!=e?e:t.nullContext||{},o=a.helperMissing,c="function",u=t.escapeExpression,p=t.lambda;return'<div class="chart-wrapper">\n\t<canvas class="chart"></canvas>\n</div>\n<form class="filters-wrapper" id="'+u((l=null!=(l=a.type||(null!=e?e.type:e))?l:o,typeof l===c?l.call(r,{name:"type",hash:{},data:s}):l))+'_filters_form">\n\t<div class="filter">\n\t\t<select multiple size="12" name="entities" id="'+u((l=null!=(l=a.type||(null!=e?e.type:e))?l:o,typeof l===c?l.call(r,{name:"type",hash:{},data:s}):l))+'_entities_select" class="entities-select">\n'+(null!=(i=a.with.call(r,null!=e?e.entities:e,{name:"with",hash:{},fn:t.program(1,s,0),inverse:t.noop,data:s}))?i:"")+'\t\t</select>\n\t</div>\n\t<div class="filter">\n\t\t<select multiple size="12" name="metrics" id="'+u((l=null!=(l=a.type||(null!=e?e.type:e))?l:o,typeof l===c?l.call(r,{name:"type",hash:{},data:s}):l))+'_metrics_select" class="metrics-select">\n'+(null!=(i=a.with.call(r,null!=e?e.metrics:e,{name:"with",hash:{},fn:t.program(1,s,0),inverse:t.noop,data:s}))?i:"")+'\t\t</select>\n\t</div>\n\t<div class="filter flex-column">\n\t\t<div class="control-group">\n\t\t\t<label for="period" class="control-label">\n\t\t\t\t'+u(p(null!=(i=null!=(i=null!=(i=null!=(i=null!=e?e.i18n:e)?i.callQueuesReportingApp:i)?i.dashboard:i)?i.labels:i)?i.period:i,e))+'\n\t\t\t</label>\n\t\t\t<div class="controls">\n\t\t\t\t<select name="period" id="'+u((l=null!=(l=a.type||(null!=e?e.type:e))?l:o,typeof l===c?l.call(r,{name:"type",hash:{},data:s}):l))+'_period_select" class="period-select">\n'+(null!=(i=a.with.call(r,null!=e?e.periods:e,{name:"with",hash:{},fn:t.program(5,s,0),inverse:t.noop,data:s}))?i:"")+'\t\t\t\t</select>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="control-group">\n\t\t\t<label for="startDate" class="control-label">\n\t\t\t\t'+u(p(null!=(i=null!=(i=null!=(i=null!=(i=null!=e?e.i18n:e)?i.callQueuesReportingApp:i)?i.dashboard:i)?i.labels:i)?i.startDate:i,e))+'\n\t\t\t</label>\n\t\t\t<div class="controls">\n\t\t\t\t<input type="text" name="start_date" id="startDate" class="date-input">\n\t\t\t</div>\n\t\t</div>\n\t\t<div class="control-group">\n\t\t\t<label for="endDate" class="control-label">\n\t\t\t\t'+u(p(null!=(i=null!=(i=null!=(i=null!=(i=null!=e?e.i18n:e)?i.callQueuesReportingApp:i)?i.dashboard:i)?i.labels:i)?i.endDate:i,e))+'\n\t\t\t</label>\n\t\t\t<div class="controls">\n\t\t\t\t<input type="text" name="end_date" id="endDate" class="date-input">\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\t<div class="filter">\n\t\t<div class="datasets-actions">\n\t\t\t<div class="action-wrapper">\n\t\t\t\t<a class="metric-action add-metric">\n\t\t\t\t\t<i class="fa fa-plus-square"></i>\n\t\t\t\t</a>\n\t\t\t</div>\n\t\t\t<div class="action-wrapper">\n\t\t\t\t<a class="metric-action remove-metric">\n\t\t\t\t\t<i class="fa fa-minus-square"></i>\n\t\t\t\t</a>\n\t\t\t</div>\n\t\t</div>\n\t\t<select multiple size="12" name="datasets" id="'+u((l=null!=(l=a.type||(null!=e?e.type:e))?l:o,typeof l===c?l.call(r,{name:"type",hash:{},data:s}):l))+'_datasets_select" class="datasets-select">\n\t\t</select>\n\t</div>\n</form>\n'},useData:!0}),this.monster.cache.templates["callqueues-reporting"]._main.layout=Handlebars.template({1:function(t,e,a,n,s){var i,l=null!=e?e:t.nullContext||{},r=a.helperMissing,o=t.escapeExpression;return'\t\t\t<li class="active">\n\t\t\t\t<a href="#'+o((i=null!=(i=a.id||(null!=e?e.id:e))?i:r,"function"==typeof i?i.call(l,{name:"id",hash:{},data:s}):i))+'_content" data-toggle="tab">\n\t\t\t\t\t'+o((i=null!=(i=a.label||(null!=e?e.label:e))?i:r,"function"==typeof i?i.call(l,{name:"label",hash:{},data:s}):i))+"\n\t\t\t\t</a>\n\t\t\t</li>\n"},3:function(t,e,a,n,s){var i,l=null!=e?e:t.nullContext||{},r=a.helperMissing,o=t.escapeExpression;return'\t\t\t<div class="tab-pane active" id="'+o((i=null!=(i=a.id||(null!=e?e.id:e))?i:r,"function"==typeof i?i.call(l,{name:"id",hash:{},data:s}):i))+'_content" data-type="'+o((i=null!=(i=a.id||(null!=e?e.id:e))?i:r,"function"==typeof i?i.call(l,{name:"id",hash:{},data:s}):i))+'">\n\t\t\t</div>\n'},compiler:[7,">= 4.0.0"],main:function(t,e,a,n,s){var i,l=null!=e?e:t.nullContext||{};return'<div class="app-content">\n\t<div class="tab-bar">\n\t\t<ul class="nav nav-tabs">\n'+(null!=(i=a.each.call(l,null!=e?e.entities:e,{name:"each",hash:{},fn:t.program(1,s,0),inverse:t.noop,data:s}))?i:"")+'\t\t</ul>\n\t\t<div class="tab-content">\n'+(null!=(i=a.each.call(l,null!=e?e.entities:e,{name:"each",hash:{},fn:t.program(3,s,0),inverse:t.noop,data:s}))?i:"")+"\t\t</div>\n\t</div>\n</div>\n"},useData:!0});